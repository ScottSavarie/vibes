/*
 * Medium.js
 *
 * Copyright 2013, Jacob Kelley - http://jakiestfu.com/
 * Released under the MIT Licence
 * http://opensource.org/licenses/MIT
 *
 * Github:  http://github.com/jakiestfu/Medium.js/
 * Version: 1.0
 */
(function(e,t){"use strict";typeof String.prototype.trim!="function"&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});var n=n||function(n){var r={debug:!0,element:null,modifier:"auto",placeholder:"",autofocus:!1,autoHR:!0,mode:"rich",maxLength:-1,modifiers:{66:"bold",73:"italicize",85:"underline",86:"paste"},tags:{paragraph:"p",outerLevel:["pre","blockquote","figure","hr"],innerLevel:["a","b","u","i","img","strong"]},cssClasses:{editor:"Medium",pasteHook:"Medium-paste-hook",placeholder:"Medium-placeholder"},attributes:{remove:["style","class"]}},i={initialized:!1,cmd:!1,focusedElement:null},s=function(e){r.debug&&console.log(e)},o={isCommand:function(e,t,n){return r.modifier==="ctrl"&&e.ctrlKey||r.modifier==="cmd"&&e.metaKey||r.modifier==="auto"&&(e.ctrlKey||e.metaKey)?t.call():n.call()},isShift:function(e,t,n){return e.shiftKey?t.call():n.call()},isModifier:function(e,t){var n=e.which,i=r.modifiers[n];if(i)return t.call(null,i)},isNotSpecial:function(e){var t={16:"shift",17:"ctrl",18:"alt",91:"cmd",8:"delete"};return i.cmd?!1:!(e.which in t)},addEvent:function(t,n,r){t.addEventListener?t.addEventListener(n,r,!1):t.attachEvent&&t.attachEvent("on"+n,r)},removeEvent:function(t,n,r){t.addEventListener?t.removeEventListener(n,r,!1):t.attachEvent&&t.detachEvent("on"+n,r)},preventDefaultEvent:function(e){e.preventDefault?e.preventDefault():e.returnValue=!1},getElementsByClassName:function(e,t){t=t?t:document.body;var n=[],r=new RegExp("(^| )"+e+"( |$)"),i=t.getElementsByTagName("*");for(var s=0,o=i.length;s<o;s++)r.test(i[s].className)&&n.push(i[s]);return n},deepExtend:function(e,t){for(var n in t)t[n]&&t[n].constructor&&t[n].constructor===Object?(e[n]=e[n]||{},o.deepExtend(e[n],t[n])):e[n]=t[n];return e},selection:{saveSelection:function(){if(e.getSelection){var n=e.getSelection();if(n.rangeCount>0)return n.getRangeAt(0)}else if(t.selection&&t.selection.createRange)return t.selection.createRange();return null},restoreSelection:function(n){if(n)if(e.getSelection){var r=e.getSelection();r.removeAllRanges(),r.addRange(n)}else t.selection&&n.select&&n.select()}},cursor:{set:function(n,r){if(t.createRange){var i=t.createRange(),s=e.getSelection(),u=o.html.lastChild(),a=o.html.text(u).length-1,f=r?r:u,l=typeof n!="undefined"?n:a;i.setStart(f,l),i.collapse(!0),s.removeAllRanges(),s.addRange(i)}else{var i=t.body.createTextRange();i.moveToElementText(r),i.collapse(!1),i.select()}}},html:{text:function(e,t){return e=e||r.element,t&&(e.textContent&&typeof e.textContent!="undefined"?e.textContent=t:e.innerText=t),(e.textContent||e.innerText).trim()},changeTag:function(e,n){var r=t.createElement(n),i,s;i=e.firstChild;while(i)s=i.nextSibling,r.appendChild(i),i=s;e.parentNode.insertBefore(r,e),e.parentNode.removeChild(e)},deleteNode:function(e){e.parentNode.removeChild(e)},placeholders:function(){var e=o.getElementsByClassName(r.cssClasses.placeholder,r.element),t=o.html.text(r.element);if(t===""){r.element.innerHTML="";if(r.placeholder.length>0){o.html.addTag(r.tags.paragraph,!1,!1);var n=o.html.lastChild();n.className=r.cssClasses.placeholder,o.html.text(n,r.placeholder)}o.html.addTag(r.tags.paragraph,i.initialized?!0:r.autofocus)}else if(t!==r.placeholder){var s;for(s=0;s<e.length;s++)o.html.deleteNode(e[s])}},clean:function(){var e=r.attributes.remove,t=r.tags.outerLevel.concat([r.tags.paragraph]),n=r.element.children,i,s,u;for(i=0;i<n.length;i++){var a=n[i],f=a.nodeName,l=!0;for(u=0;u<e.length;u++)a.hasAttribute(e[u])&&a.getAttribute(e[u])!==r.cssClasses.placeholder&&a.removeAttribute(e[u]);for(s=0;s<t.length;s++)t[s]===f.toLowerCase()&&(l=!1);if(l)switch(f.toLowerCase()){case"div":o.html.changeTag(a,r.tags.paragraph);break;default:o.html.deleteNode(a)}}},lastChild:function(){return r.element.lastChild},addTag:function(e,n,s,u){var a=t.createElement(e),f;typeof s!="undefined"&&s===!1&&(a.contentEditable=!1),a.innerHTML=" ",u&&u.nextSibling?(u.parentNode.insertBefore(a,u.nextSibling),f=u.nextSibling):(r.element.appendChild(a),f=o.html.lastChild()),n&&(i.focusedElement=f,o.cursor.set(0,f))}},pasteHook:function(e){var n=t.createElement("textarea");n.className=r.cssClasses.pasteHook,r.element.appendChild(n);var i=o.getElementsByClassName(r.cssClasses.pasteHook,r.element)[0];i.focus(),setTimeout(function(){var t=i.value;e.call(null,t),o.html.deleteNode(i)},1)}},u={focus:function(e){},down:function(e){o.isCommand(e,function(){i.cmd=!0},function(){i.cmd=!1}),o.isShift(e,function(){i.shift=!0},function(){i.shift=!1}),o.isModifier(e,function(t){if(i.cmd){if((r.mode==="inline"||r.mode==="partial")&&t!=="paste")return;u.command[t].call(null,e)}});if(r.maxLength!==-1){var t=r.element.getElementsByClassName(r.cssClasses.placeholder)[0],n=o.html.text().length;r.placeholder&&t&&(n-=r.placeholder.length);if(n>=r.maxLength&&o.isNotSpecial(e))return o.preventDefaultEvent(e);s(n+"/"+r.maxLength)}e.which===13&&u.enterKey.call(null,e)},up:function(e){o.isCommand(e,function(){i.cmd=!1},function(){i.cmd=!0}),o.html.clean(),o.html.placeholders(),a.preserveElementFocus()},command:{bold:function(e){o.preventDefaultEvent(e),t.execCommand("bold",!1),s("Bold")},underline:function(e){o.preventDefaultEvent(e),t.execCommand("underline",!1),s("Underline")},italicize:function(e){o.preventDefaultEvent(e),t.execCommand("italic",!1),s("Italic")},quote:function(e){},paste:function(e){var n=o.selection.saveSelection();o.pasteHook(function(e){o.selection.restoreSelection(n),t.execCommand("insertHTML",!1,e.replace(/\n/g,"<br>"))})}},enterKey:function(e){if(r.mode==="inline")return o.preventDefaultEvent(e);if(!i.shift){o.preventDefaultEvent(e);var t=i.focusedElement;if(r.autoHR&&r.mode!=="partial"){var n=r.element.children,s=n[n.length-1],u=o.html.text(s)===""&&s.nodeName.toLowerCase()===r.tags.paragraph;if(u&&n.length>=2){var a=n[n.length-2];a.nodeName.toLowerCase()==="hr"&&(u=!1)}u&&(o.preventDefaultEvent(e),o.html.deleteNode(s),o.html.addTag("hr",!1,!1,t),t=t.nextSibling),o.html.addTag(r.tags.paragraph,!0,null,t)}else o.html.addTag(r.tags.paragraph,!0,null,t)}}},a={listen:function(){o.addEvent(r.element,"keyup",u.up),o.addEvent(r.element,"keydown",u.down),o.addEvent(r.element,"focus",u.focus)},preserveElementFocus:function(){var n=e.getSelection?e.getSelection().anchorNode:t.activeElement;if(n){var s=n.parentNode,o=r.element.children,u=s!==i.focusedElement,a=0,f;s===r.element&&(s=n);for(f=0;f<o.length;f++)if(s===o[f]){a=f;break}u&&(i.focusedElement=s,i.focusedElementIndex=a)}}},f=function(e){for(var t in r)if(typeof r[t]!="object"&&r.hasOwnProperty(t)&&e.element.getAttribute("data-medium-"+t)){var n=e.element.getAttribute("data-medium-"+t);if(n.toLowerCase()==="false"||n.toLowerCase()==="true")n=n.toLowerCase()==="true";r[t]=n}o.deepExtend(r,e),r.element.contentEditable=!0,r.element.className+=" "+r.cssClasses.editor,r.element.className+=" "+r.cssClasses.editor+"-"+r.mode,o.html.clean(),o.html.placeholders(),a.preserveElementFocus(),a.listen(),i.initialized=!0};this.destroy=function(){o.removeEvent(r.element,"keyup",u.up),o.removeEvent(r.element,"keydown",u.down),o.removeEvent(r.element,"focus",u.focus)},f(n)};typeof module!="undefined"&&module.exports&&(module.exports=n),typeof ender=="undefined"&&(this.Medium=n),typeof define=="function"&&define.amd&&define("Medium",[],function(){return n})}).call(this,window,document);